<!DOCTYPE html><html lang="en"><head><title>main</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="main"><meta name="groc-project-path" content="lib/main.js"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path">lib/main.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="kr">const</span> <span class="nx">widgets</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;widget&quot;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;self&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">tabs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;tabs&quot;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">file</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">clipboard</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;clipboard&quot;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">keyserver</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;util/hkp&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="p">{</span><span class="nx">ppgapp</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;ppgapp&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="p">{</span><span class="nx">getStr</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;util/lang&quot;</span><span class="p">);</span>
<span class="kr">const</span> <span class="p">{</span><span class="nx">storage</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;ring/storage&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="p">{</span><span class="nx">filePicker</span><span class="p">,</span> <span class="nx">saveFilePicker</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;util/filepicker&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">logger</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;util/logger&#39;</span><span class="p">).</span><span class="nx">create</span><span class="p">(</span><span class="s2">&quot;main.js&quot;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">wu</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;window-utils&quot;</span><span class="p">);</span>



<span class="kd">let</span> <span class="nx">mappings</span> <span class="o">=</span> <span class="p">[];</span>
<span class="kd">var</span> <span class="nx">location</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">apptab</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>var pageMod = require("page-mod");
pageMod.PageMod({
 include: "*",
 contentScript: 'var dataurl = "' + data.url() + '";RoundCube.init(dataurl);',
 contentScriptFile: [
                      data.url("ui/ejs<em>production.js"),
                      data.url("ui/ppg-lib.js"),
                      data.url('ui/views/box.js'),
                      data.url('ui/views/boxes.js'),
                      data.url('ui/views/keylist</em>view.js'),
                      data.url('ui/views/key<em>view.js'),
                      data.url('ui/views/key</em>subkey<em>view.js'),
                      data.url('ui/views/key</em>uid<em>view.js'),
                      data.url('ui/views/key</em>uidsig<em>view.js'),
                      data.url('ui/sprintf.js'),
                      data.url('ui/tabs.js'),
                      data.url("ui/firegpg.js"),
                      data.url("ui/firegpg-inline.js"),
                      data.url("ui/firegpg-cselect.js"),
                      data.url("ui/rc.js"),
                    ],
 contentScriptWhen: 'end',
 onAttach: function onAttach(worker) {
   load</em>events(worker);
 }</p></div></div><div class="code"><div class="wrapper"><span class="c1">//});</span>

<span class="kd">function</span> <span class="nx">start</span><span class="p">(</span><span class="nx">chromeWindow</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">XULBrowserWindow</span> <span class="o">=</span> <span class="nx">chromeWindow</span><span class="p">.</span><span class="nx">XULBrowserWindow</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">originalFunction</span> <span class="o">=</span> <span class="nx">XULBrowserWindow</span><span class="p">.</span><span class="nx">hideChromeForLocation</span><span class="p">;</span>

  <span class="nx">mappings</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nb">window</span><span class="o">:</span> <span class="nx">chromeWindow</span><span class="p">,</span> <span class="nx">originalFunction</span><span class="o">:</span> <span class="nx">originalFunction</span><span class="p">});</span>

  <span class="nx">XULBrowserWindow</span><span class="p">.</span><span class="nx">hideChromeForLocation</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">aLocation</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">originalFunction</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">XULBrowserWindow</span><span class="p">,</span> <span class="nx">aLocation</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">aLocation</span> <span class="o">==</span> <span class="nx">apptab</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">stop</span><span class="p">(</span><span class="nx">chromeWindow</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">mappings</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">pair</span> <span class="o">=</span> <span class="nx">mappings</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">chromeWindow</span> <span class="o">===</span> <span class="nx">pair</span><span class="p">.</span><span class="nb">window</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">chromeWindow</span><span class="p">.</span><span class="nx">XULBrowserWindow</span><span class="p">.</span><span class="nx">hideChromeForLocation</span> <span class="o">=</span> <span class="nx">pair</span><span class="p">.</span><span class="nx">originalFunction</span><span class="p">;</span>
      <span class="nx">mappings</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">triggerOnLocationChange</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">win</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">ownerDocument</span><span class="p">.</span><span class="nx">defaultView</span><span class="p">;</span>
  <span class="nx">win</span><span class="p">.</span><span class="nx">XULBrowserWindow</span><span class="p">.</span><span class="nx">onLocationChange</span><span class="p">(</span>
    <span class="p">{</span><span class="nx">DOMWindow</span><span class="o">:</span> <span class="nx">win</span><span class="p">.</span><span class="nx">content</span><span class="p">},</span> <span class="cm">/* stub aWebProgress obj */</span>
    <span class="kc">null</span><span class="p">,</span>
    <span class="nx">win</span><span class="p">.</span><span class="nx">gBrowser</span><span class="p">.</span><span class="nx">selectedTab</span><span class="p">.</span><span class="nx">location</span>
  <span class="p">);</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">delegate</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">onTrack</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nb">window</span><span class="p">)</span> <span class="nx">start</span><span class="p">(</span><span class="nb">window</span><span class="p">),</span>
  <span class="nx">onUntrack</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nb">window</span><span class="p">)</span> <span class="nx">stop</span><span class="p">(</span><span class="nb">window</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">new</span> <span class="nx">wu</span><span class="p">.</span><span class="nx">WindowTracker</span><span class="p">(</span><span class="nx">delegate</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">sectionsContentScripts</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">get_all_options</span><span class="p">();</span>
  <span class="k">return</span> <span class="s2">&quot;\nUI.init( &quot;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;);&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">load_events</span><span class="p">(</span><span class="nx">worker</span><span class="p">){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ul>
<li>list of events *//
pgp-key-generate --> &lt;-- pgp-key-generated
                 &lt;-- pgp-key-imported
pgp-key-parse    --> &lt;-- pgp-key-parsed
pgp-key-import   --> &lt;-- pgp-key-imported
pgp-key-remove   --> &lt;-- pgp-key-removed</li>
</ul></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>pgp-msg-decrypt  --> &lt;-- pgp-msg-decrypted
pgp-msg-encrypt  --> &lt;-- pgp-msg-encrypted</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>pgp-msg-sign     --> &lt;-- pgp-msg-signed
pgp-msg-verify   --> &lt;-- pgp-msg-verified
                     &lt;-- pgp-key-list</p></div></div><div class="code"><div class="wrapper">  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>pgp-ui-open      --> 
                     &lt;-- pgp-ui-open</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>pgp-fetch-keyring --> &lt;-- pgp-fetched-keyring</p></div></div><div class="code"><div class="wrapper">  <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;pgp-pubexport&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">response</span> <span class="o">=</span> <span class="p">{</span><span class="nx">rc</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">armored_key</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">msg</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">};</span>
    <span class="k">try</span> <span class="p">{</span> 
      <span class="nx">response</span><span class="p">.</span><span class="nx">armored_key</span> <span class="o">=</span> <span class="nx">ppgapp</span><span class="p">.</span><span class="nx">exportPublic</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">keyids</span><span class="p">);</span>
      <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-pubexported&quot;</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
      <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-pubexported&quot;</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
  <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;pgp-secexport&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">response</span> <span class="o">=</span> <span class="p">{</span><span class="nx">rc</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">armored_key</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">msg</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">};</span>
    <span class="k">try</span> <span class="p">{</span> 
      <span class="nx">response</span><span class="p">.</span><span class="nx">armored_key</span> <span class="o">=</span> <span class="nx">ppgapp</span><span class="p">.</span><span class="nx">exportSecret</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">keyid</span><span class="p">);</span>
      <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-secexported&quot;</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
      <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-secexported&quot;</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
  <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;pgp-secexportto&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="p">{</span><span class="nx">keyid</span><span class="p">,</span> <span class="nx">to</span><span class="p">}</span> <span class="o">=</span> <span class="nx">params</span><span class="p">;</span>
    <span class="nx">res</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">rc</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">msg</span><span class="o">:</span> <span class="s2">&quot;&quot;</span> <span class="p">};</span>
    <span class="k">switch</span><span class="p">(</span><span class="nx">to</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="s2">&quot;toclipboard&quot;</span><span class="o">:</span>
        <span class="nx">clipboard</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">ppgapp</span><span class="p">.</span><span class="nx">exportSecret</span><span class="p">(</span><span class="nx">keyid</span><span class="p">));</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="s2">&quot;Copied to clipboard!&quot;</span><span class="p">;</span>
        <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-exportedto&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s2">&quot;tofile&quot;</span><span class="o">:</span>
        <span class="kd">var</span> <span class="nx">filename</span> <span class="o">=</span> <span class="nx">saveFilePicker</span><span class="p">().</span><span class="nx">path</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">filename</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">stream</span> <span class="o">=</span> <span class="nx">file</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">stream</span><span class="p">)</span> 
            <span class="k">try</span> <span class="p">{</span>
              <span class="nx">stream</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">ppgapp</span><span class="p">.</span><span class="nx">exportSecret</span><span class="p">(</span><span class="nx">keyid</span><span class="p">));</span>
              <span class="nx">stream</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
              <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="s2">&quot;Exported to file &quot;</span> <span class="o">+</span> <span class="nx">filename</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
            <span class="p">}</span>
          <span class="k">else</span> 
            <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="s2">&quot;Open file &quot;</span> <span class="o">+</span> <span class="nx">filename</span> <span class="o">+</span> <span class="s2">&quot; failed&quot;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="s2">&quot;Export cancelled!&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">default</span><span class="o">:</span> 
        <span class="nx">res</span><span class="p">.</span><span class="nx">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="s2">&quot;Bug: unkown export method &quot;</span> <span class="o">+</span> <span class="nx">to</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-exportedto&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;pgp-export&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="p">{</span><span class="nx">keyids</span><span class="p">,</span> <span class="nx">to</span><span class="p">}</span> <span class="o">=</span> <span class="nx">params</span><span class="p">;</span>
    <span class="nx">res</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">rc</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">msg</span><span class="o">:</span> <span class="s2">&quot;&quot;</span> <span class="p">};</span>
    <span class="k">switch</span><span class="p">(</span><span class="nx">to</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="s2">&quot;toclipboard&quot;</span><span class="o">:</span>
        <span class="nx">clipboard</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">ppgapp</span><span class="p">.</span><span class="nx">exportPublic</span><span class="p">(</span><span class="nx">keyids</span><span class="p">));</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="s2">&quot;Copied to clipboard!&quot;</span><span class="p">;</span>
        <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-exportedto&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s2">&quot;tofile&quot;</span><span class="o">:</span>
        <span class="kd">var</span> <span class="nx">filename</span> <span class="o">=</span> <span class="nx">saveFilePicker</span><span class="p">().</span><span class="nx">path</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">filename</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">stream</span> <span class="o">=</span> <span class="nx">file</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">stream</span><span class="p">)</span> 
            <span class="k">try</span> <span class="p">{</span>
              <span class="nx">stream</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">ppgapp</span><span class="p">.</span><span class="nx">exportPublic</span><span class="p">(</span><span class="nx">keyids</span><span class="p">));</span>
              <span class="nx">stream</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
              <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="s2">&quot;Exported to file &quot;</span> <span class="o">+</span> <span class="nx">filename</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
            <span class="p">}</span>
          <span class="k">else</span> 
            <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="s2">&quot;Open file &quot;</span> <span class="o">+</span> <span class="nx">filename</span> <span class="o">+</span> <span class="s2">&quot; failed&quot;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="s2">&quot;Export cancelled!&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s2">&quot;tokeyserver&quot;</span><span class="o">:</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="s2">&quot;Export key server not implemented&quot;</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">default</span><span class="o">:</span> 
        <span class="nx">res</span><span class="p">.</span><span class="nx">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="s2">&quot;Bug: unkown export method &quot;</span> <span class="o">+</span> <span class="nx">to</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-exportedto&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;savetofile&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="p">{</span><span class="nx">rc</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">msg</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">};</span>
    <span class="kd">var</span> <span class="nx">filename</span> <span class="o">=</span> <span class="nx">saveFilePicker</span><span class="p">().</span><span class="nx">path</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">filename</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">filename</span> <span class="o">=</span> <span class="nx">filename</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">stream</span> <span class="o">=</span> <span class="nx">file</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">stream</span><span class="p">)</span> 
        <span class="k">try</span> <span class="p">{</span>
          <span class="nx">stream</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>
          <span class="nx">stream</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="s2">&quot;Saved to file &quot;</span> <span class="o">+</span> <span class="nx">filename</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="k">else</span>  <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="s2">&quot;Open file &quot;</span> <span class="o">+</span> <span class="nx">filename</span> <span class="o">+</span> <span class="s2">&quot; failed&quot;</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="s2">&quot;Save to file cancelled!&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;savedtofile&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;clipboard-copy&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">clipboard</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>  
  <span class="p">});</span>
  <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;pgp-create-uid&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="p">{</span><span class="nx">rc</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">msg</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">};</span>
    <span class="nx">ppgapp</span><span class="p">.</span><span class="nx">generateUserId</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">keyid</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">uid</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="nx">err</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="s2">&quot;Create User Id &quot;</span> <span class="o">+</span> <span class="nx">uid</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">key</span> <span class="o">=</span> <span class="nx">key</span><span class="p">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">uid</span> <span class="o">=</span> <span class="nx">uid</span><span class="p">;</span>
        <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-created-uid&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">});</span>
  <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;pgp-update-uid-selfsig&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="p">{</span><span class="nx">rc</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">uid_num</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">uid_num</span><span class="p">,</span> <span class="nx">msg</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">};</span>
    <span class="nx">ppgapp</span><span class="p">.</span><span class="nx">editUserId</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">keyid</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">uid_num</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">expireseconds</span><span class="p">,</span> 
      <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">uid</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="nx">err</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">key</span> <span class="o">=</span> <span class="nx">key</span><span class="p">;</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">uid</span> <span class="o">=</span> <span class="nx">uid</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-updated-uid-selfsig&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">);</span>
  <span class="p">});</span>
  <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;pgp-create-subkey&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="p">{</span><span class="nx">rc</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">msg</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">};</span>
    <span class="nx">ppgapp</span><span class="p">.</span><span class="nx">generateSubkey</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">keyid</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">subkey</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="nx">err</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="s2">&quot;Created subkey &quot;</span> <span class="o">+</span> <span class="nx">subkey</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">key</span> <span class="o">=</span> <span class="nx">key</span><span class="p">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">subkey</span> <span class="o">=</span> <span class="nx">subkey</span><span class="p">;</span>
        <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-created-subkey&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">});</span>
  <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;pgp-revoke-key&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">{</span><span class="nx">rc</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span> <span class="nx">keyid</span><span class="o">:</span><span class="nx">req</span><span class="p">.</span><span class="nx">keyid</span><span class="p">};</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">reason</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">reason</span> <span class="o">||</span> <span class="s2">&quot;Revoked from PidgeonPG-UI&quot;</span><span class="p">;</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">comment</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">comment</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="nx">ppgapp</span><span class="p">.</span><span class="nx">revokeKey</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">keyid</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">reason</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">comment</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">result</span><span class="p">.</span><span class="nx">key</span> <span class="o">=</span> <span class="nx">key</span><span class="p">;</span>
        <span class="nx">result</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="s2">&quot;Key Revoked: keyid=&quot;</span> <span class="o">+</span> <span class="nx">key</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
        <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-revoked-key&quot;</span><span class="p">,</span> <span class="nx">result</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">result</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="s2">&quot;Key &quot;</span> <span class="o">+</span> <span class="nx">result</span><span class="p">.</span><span class="nx">keyid</span> <span class="o">+</span> <span class="s2">&quot; was not revoked: &quot;</span> <span class="o">+</span> <span class="nx">e</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
      <span class="nx">result</span><span class="p">.</span><span class="nx">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-revoked-key&quot;</span><span class="p">,</span> <span class="nx">result</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
  <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;pgp-revoke-uid&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">{</span><span class="nx">rc</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span> <span class="nx">keyid</span><span class="o">:</span><span class="nx">req</span><span class="p">.</span><span class="nx">keyid</span><span class="p">};</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">reason</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">reason</span> <span class="o">||</span> <span class="s2">&quot;Revoked from PidgeonPG-UI&quot;</span><span class="p">;</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">comment</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">comment</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="nx">ppgapp</span><span class="p">.</span><span class="nx">revokeUserId</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">keyid</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">uid_index</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">reason</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">comment</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">uid</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">result</span><span class="p">.</span><span class="nx">key</span> <span class="o">=</span> <span class="nx">key</span><span class="p">;</span>
        <span class="nx">result</span><span class="p">.</span><span class="nx">uid</span> <span class="o">=</span> <span class="nx">uid</span><span class="p">;</span>
        <span class="nx">result</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="s2">&quot;Key Revoked: keyid=&quot;</span> <span class="o">+</span> <span class="nx">result</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
        <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-revoked-uid&quot;</span><span class="p">,</span> <span class="nx">result</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">result</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="s2">&quot;Key &quot;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">keyid</span> <span class="o">+</span> <span class="s2">&quot; was not revoked: &quot;</span> <span class="o">+</span> <span class="nx">e</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
      <span class="nx">result</span><span class="p">.</span><span class="nx">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-revoked-uid&quot;</span><span class="p">,</span> <span class="nx">result</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
  <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;pgp-revoke-subkey&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">{</span><span class="nx">rc</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span> <span class="nx">keyid</span><span class="o">:</span><span class="nx">req</span><span class="p">.</span><span class="nx">subkeyid</span><span class="p">};</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">reason</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">reason</span> <span class="o">||</span> <span class="s2">&quot;Revoked from PidgeonPG-UI&quot;</span><span class="p">;</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">comment</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">comment</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="nx">ppgapp</span><span class="p">.</span><span class="nx">revokeSubkey</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">subkeyid</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">reason</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">comment</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">subkey</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">result</span><span class="p">.</span><span class="nx">key</span> <span class="o">=</span> <span class="nx">key</span><span class="p">;</span>
        <span class="nx">result</span><span class="p">.</span><span class="nx">subkey</span> <span class="o">=</span> <span class="nx">subkey</span><span class="p">;</span>
        <span class="nx">result</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="s2">&quot;Subkey revoked: keyid=&quot;</span> <span class="o">+</span> <span class="nx">result</span><span class="p">.</span><span class="nx">subkey</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
        <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-revoked-subkey&quot;</span><span class="p">,</span> <span class="nx">result</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">result</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="s2">&quot;Key &quot;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">subkeyid</span> <span class="o">+</span> <span class="s2">&quot; was not revoked: &quot;</span> <span class="o">+</span> <span class="nx">e</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
      <span class="nx">result</span><span class="p">.</span><span class="nx">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-revoked-uid&quot;</span><span class="p">,</span> <span class="nx">result</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
  <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;pgp-sign-uid&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">keyid_str</span><span class="p">,</span> <span class="nx">uid_name</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="p">{</span><span class="nx">rc</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">msg</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">};</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="nx">ppgapp</span><span class="p">.</span><span class="nx">signUserId</span><span class="p">(</span><span class="nx">keyid_str</span><span class="p">,</span> <span class="nx">uid_name</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">uid</span><span class="p">,</span> <span class="nx">uid_num</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">key</span> <span class="o">=</span> <span class="nx">key</span><span class="p">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">uid</span> <span class="o">=</span> <span class="nx">uid</span><span class="p">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">uid_num</span> <span class="o">=</span> <span class="nx">uid_num</span><span class="p">;</span>
        <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-signed-uid&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="s2">&quot;Could&#39;t sign user id&quot;</span><span class="p">;</span>
      <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-signed-uid&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
  <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;keyserver-search&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="p">{</span><span class="nx">rc</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ts</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">ts</span><span class="p">,</span> <span class="nx">keys</span><span class="o">:</span> <span class="kc">null</span><span class="p">};</span>
    <span class="kd">var</span> <span class="nx">ks</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">keyserver</span><span class="p">.</span><span class="nx">KeyServer</span><span class="p">(</span><span class="nx">storage</span><span class="p">.</span><span class="nx">get_option</span><span class="p">(</span><span class="s2">&quot;keyserver&quot;</span><span class="p">));</span>
    <span class="nx">ks</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">serverkeys</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">rc</span> <span class="o">=</span> <span class="s2">&quot;-1&quot;</span><span class="p">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="nx">err</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
      <span class="p">}</span> <span class="k">else</span> 
        <span class="nx">res</span><span class="p">.</span><span class="nx">keys</span> <span class="o">=</span> <span class="nx">serverkeys</span><span class="p">;</span>
      <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;keyserver-search-result&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>

  <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;pgp-options-get-all&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-options-got-all&quot;</span><span class="p">,</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">get_all_options</span><span class="p">());</span>
  <span class="p">});</span>
  <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;pgp-option-get-keyserver&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-option-got-keyserver&quot;</span><span class="p">,</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">get_option</span><span class="p">(</span><span class="s2">&quot;keyserver&quot;</span><span class="p">));</span>
  <span class="p">});</span>
  <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;pgp-options-set&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">option</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="nx">storage</span><span class="p">.</span><span class="nx">set_option</span><span class="p">(</span><span class="nx">option</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
      <span class="k">switch</span> <span class="p">(</span><span class="nx">option</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="s2">&quot;lang&quot;</span><span class="o">:</span>
          <span class="nx">language</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
          <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-option-set-language&quot;</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="s2">&quot;keyserver&quot;</span><span class="o">:</span>
          <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-option-set-keyserver&quot;</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="s2">&quot;defaultkey&quot;</span><span class="o">:</span>
          <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-option-set-defaultkey&quot;</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">option</span><span class="o">:</span> <span class="nx">option</span><span class="p">,</span>
                  <span class="nx">value</span><span class="o">:</span>  <span class="nx">value</span><span class="p">,</span>
                  <span class="nx">error</span><span class="o">:</span>  <span class="nx">e</span><span class="p">.</span><span class="nx">toString</span><span class="p">()};</span>
      <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-option-set-error&quot;</span><span class="p">,</span> <span class="nx">ret</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;pgp-key-parse&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">ts</span><span class="p">,</span> <span class="nx">keyids</span><span class="p">,</span> <span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">keydata</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">response</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">rc</span>   <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
                     <span class="nx">ts</span>   <span class="o">:</span> <span class="nx">ts</span><span class="p">,</span>
                     <span class="nx">msg</span>  <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                     <span class="nx">keydata</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                     <span class="nx">keys</span> <span class="o">:</span> <span class="p">[]</span> <span class="p">}</span>
    <span class="k">switch</span><span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="s2">&quot;file&quot;</span><span class="o">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">pickedfile</span> <span class="o">=</span> <span class="nx">filePicker</span><span class="p">())</span> <span class="p">{</span>
          <span class="nx">keydata</span> <span class="o">=</span> <span class="nx">file</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="nx">pickedfile</span><span class="p">.</span><span class="nx">path</span><span class="p">);</span>
          <span class="nx">response</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="nx">getStr</span><span class="p">(</span><span class="s2">&quot;fromfile&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nx">pickedfile</span><span class="p">.</span><span class="nx">path</span><span class="p">;</span>
          <span class="nx">ppgapp</span><span class="p">.</span><span class="nx">importData</span><span class="p">(</span><span class="nx">keydata</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">formatted_key</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">formatted_key</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-keyblock-parsed&quot;</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="nx">response</span><span class="p">.</span><span class="nx">key</span> <span class="o">=</span> <span class="nx">formatted_key</span><span class="p">;</span>
              <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-key-imported&quot;</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span>
            <span class="p">}</span>
          <span class="p">});</span>
            
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">response</span><span class="p">.</span><span class="nx">rc</span> <span class="o">=</span> <span class="s2">&quot;-1&quot;</span><span class="p">;</span>
          <span class="nx">response</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="nx">getStr</span><span class="p">(</span><span class="s2">&quot;selcancel&quot;</span><span class="p">);</span>
          <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-keyblock-parsed&quot;</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s2">&quot;text&quot;</span><span class="o">:</span>
        <span class="nx">keydata</span> <span class="o">=</span> <span class="nx">text</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">keydata</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">foundany</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
          <span class="nx">ppgapp</span><span class="p">.</span><span class="nx">importData</span><span class="p">(</span><span class="nx">keydata</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">formatted_key</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>XXX error no callback sometimes!</p></div></div><div class="code"><div class="wrapper">            <span class="k">if</span> <span class="p">(</span><span class="nx">formatted_key</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">foundany</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
              <span class="nx">response</span><span class="p">.</span><span class="nx">key</span> <span class="o">=</span> <span class="nx">formatted_key</span><span class="p">;</span>
              <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-key-imported&quot;</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="nx">response</span><span class="p">.</span><span class="nx">keydata</span> <span class="o">=</span> <span class="nx">keydata</span><span class="p">;</span>
              <span class="nx">response</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="nx">foundany</span> <span class="o">?</span> <span class="nx">getStr</span><span class="p">(</span><span class="s2">&quot;fromclipboard&quot;</span><span class="p">)</span> <span class="o">:</span>
                                        <span class="nx">getStr</span><span class="p">(</span><span class="s2">&quot;errfromclipboard&quot;</span><span class="p">);</span>
              <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-keyblock-parsed&quot;</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span>
            <span class="p">}</span>
          <span class="p">});</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">response</span><span class="p">.</span><span class="nx">rc</span> <span class="o">=</span> <span class="s2">&quot;-2&quot;</span><span class="p">;</span>
          <span class="nx">response</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="nx">getStr</span><span class="p">(</span><span class="s2">&quot;selcancel&quot;</span><span class="p">);</span>
          <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-keyblock-parsed&quot;</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s2">&quot;clipboard&quot;</span><span class="o">:</span>
        <span class="nx">keydata</span> <span class="o">=</span> <span class="nx">clipboard</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">keydata</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">foundany</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
          <span class="nx">ppgapp</span><span class="p">.</span><span class="nx">importData</span><span class="p">(</span><span class="nx">keydata</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">formatted_key</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>XXX error no callback sometimes!</p></div></div><div class="code"><div class="wrapper">            <span class="k">if</span> <span class="p">(</span><span class="nx">formatted_key</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">foundany</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
              <span class="nx">response</span><span class="p">.</span><span class="nx">key</span> <span class="o">=</span> <span class="nx">formatted_key</span><span class="p">;</span>
              <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-key-imported&quot;</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="nx">response</span><span class="p">.</span><span class="nx">keydata</span> <span class="o">=</span> <span class="nx">keydata</span><span class="p">;</span>
              <span class="nx">response</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="nx">foundany</span> <span class="o">?</span> <span class="nx">getStr</span><span class="p">(</span><span class="s2">&quot;fromclipboard&quot;</span><span class="p">)</span> <span class="o">:</span>
                                        <span class="nx">getStr</span><span class="p">(</span><span class="s2">&quot;errfromclipboard&quot;</span><span class="p">);</span>
              <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-keyblock-parsed&quot;</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span>
            <span class="p">}</span>
          <span class="p">});</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">response</span><span class="p">.</span><span class="nx">rc</span> <span class="o">=</span> <span class="s2">&quot;-2&quot;</span><span class="p">;</span>
          <span class="nx">response</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="nx">getStr</span><span class="p">(</span><span class="s2">&quot;selcancel&quot;</span><span class="p">);</span>
          <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-keyblock-parsed&quot;</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s2">&quot;keyserver&quot;</span><span class="o">:</span>
        <span class="kd">var</span> <span class="nx">ks</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">keyserver</span><span class="p">.</span><span class="nx">KeyServer</span><span class="p">(</span><span class="nx">storage</span><span class="p">.</span><span class="nx">get_option</span><span class="p">(</span><span class="s2">&quot;keyserver&quot;</span><span class="p">));</span>
        <span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">keyids</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">ks</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">keyids</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">keydata</span><span class="p">)</span> <span class="p">{</span>            
            <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">rc</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ts</span><span class="o">:</span> <span class="nx">ts</span><span class="p">,</span> <span class="nx">msg</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">keydata</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">keys</span> <span class="o">:</span> <span class="p">[]</span> <span class="p">};</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="o">==</span><span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="s2">&quot;Imported from keyserver&quot;</span><span class="p">;</span>
              <span class="nx">ppgapp</span><span class="p">.</span><span class="nx">importData</span><span class="p">(</span><span class="nx">keydata</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">formatted_key</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">formatted_key</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">count</span><span class="o">++</span><span class="p">;</span>
                  <span class="nx">res</span><span class="p">.</span><span class="nx">key</span> <span class="o">=</span> <span class="nx">formatted_key</span><span class="p">;</span>
                  <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-key-imported&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">count</span> <span class="o">==</span> <span class="nx">keyids</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-keyblock-parsed&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
                <span class="p">}</span>
              <span class="p">});</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="nx">count</span><span class="o">++</span><span class="p">;</span>
              <span class="nx">res</span><span class="p">.</span><span class="nx">rc</span> <span class="o">=</span> <span class="s2">&quot;-3&quot;</span><span class="p">;</span>
              <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span>  <span class="o">=</span> <span class="nx">err</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">count</span> <span class="o">==</span> <span class="nx">keyids</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
                <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-keyblock-parsed&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
              <span class="k">else</span>
                <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-key-imported&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
            <span class="p">}</span>
          <span class="p">});</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">default</span><span class="o">:</span>
        <span class="nx">response</span><span class="p">.</span><span class="nx">rc</span> <span class="o">=</span> <span class="s2">&quot;-4&quot;</span><span class="p">;</span>
        <span class="nx">response</span><span class="p">.</span><span class="nx">msg</span>  <span class="o">=</span> <span class="s2">&quot;ERROR: unknow importing source&quot;</span><span class="p">;</span>
        <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-keyblock-parsed&quot;</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Unknown importing source&quot;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>


  <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;pgp-key-generate&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="p">{</span><span class="nx">rc</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ts</span><span class="o">:</span> <span class="nx">params</span><span class="p">.</span><span class="nx">seqts</span><span class="p">};</span>
    <span class="nx">ppgapp</span><span class="p">.</span><span class="nx">generateKeypair</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="nx">err</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">key</span> <span class="o">=</span> <span class="nx">key</span><span class="p">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="nx">getStr</span><span class="p">(</span><span class="s2">&quot;generated&quot;</span><span class="p">,</span> <span class="nx">key</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
        <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-key-imported&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-key-generated&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>

  <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;pgp-key-remove&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">keyidstr</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="nx">ppgapp</span><span class="p">.</span><span class="nx">removeKey</span><span class="p">(</span><span class="nx">keyidstr</span><span class="p">);</span>
    <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-key-removed&quot;</span><span class="p">,</span> <span class="nx">keyidstr</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;pgp-msg-decrypt&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="p">{</span><span class="nx">rc</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ts</span><span class="o">:</span> <span class="nx">params</span><span class="p">.</span><span class="nx">ts</span><span class="p">};</span>
    <span class="nx">ppgapp</span><span class="p">.</span><span class="nx">decrypt</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">msg</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">decmsg</span><span class="p">,</span> <span class="nx">enc_keyid</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">enc_keyid</span> <span class="o">=</span> <span class="nx">enc_keyid</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="nx">err</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">rc</span> <span class="o">=</span> <span class="nx">decmsg</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span> 
        <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="nx">decmsg</span><span class="p">.</span><span class="nx">msg</span><span class="p">;</span> 
        <span class="nx">res</span><span class="p">.</span><span class="nx">sign_keyid</span> <span class="o">=</span> <span class="nx">decmsg</span><span class="p">.</span><span class="nx">sign_keyid</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">decmsg</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">ppgapp</span><span class="p">.</span><span class="nx">findKey</span><span class="p">(</span><span class="nx">decmsg</span><span class="p">.</span><span class="nx">sign_keyid</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">key</span><span class="p">)</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">sign_key_uid</span> <span class="o">=</span> <span class="nx">key</span><span class="p">.</span><span class="nx">uids</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">name</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-msg-decrypted&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
  <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;pgp-msg-encrypt&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="p">{</span><span class="nx">rc</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ts</span><span class="o">:</span> <span class="nx">params</span><span class="p">.</span><span class="nx">ts</span><span class="p">,</span> <span class="nx">enc_keyid</span><span class="o">:</span> <span class="nx">params</span><span class="p">.</span><span class="nx">enc_keyid</span><span class="p">,</span> <span class="nx">sign_keyid</span><span class="o">:</span> <span class="nx">params</span><span class="p">.</span><span class="nx">sign_keyid</span><span class="p">};</span>
    <span class="nx">ppgapp</span><span class="p">.</span><span class="nx">encrypt</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">msg</span><span class="p">,</span> <span class="p">[</span><span class="nx">params</span><span class="p">.</span><span class="nx">enc_keyid</span><span class="p">],</span> <span class="nx">params</span><span class="p">.</span><span class="nx">sign_keyid</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="nx">err</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-msg-encrypted&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
  <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;pgp-msg-sign&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="p">{</span><span class="nx">rc</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ts</span><span class="o">:</span> <span class="nx">params</span><span class="p">.</span><span class="nx">ts</span><span class="p">,</span> <span class="nx">sig</span><span class="o">:</span> <span class="nx">params</span><span class="p">.</span><span class="nx">keyid</span><span class="p">};</span>
    <span class="nx">ppgapp</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">params</span><span class="p">.</span><span class="nx">keyid</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="nx">err</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-msg-signed&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
  <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;pgp-msg-verify&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="p">{</span><span class="nx">rc</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ts</span><span class="o">:</span> <span class="nx">params</span><span class="p">.</span><span class="nx">ts</span><span class="p">};</span>
    <span class="nx">ppgapp</span><span class="p">.</span><span class="nx">verify</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">msg</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">valid</span><span class="p">,</span> <span class="nx">keyid</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;PGP.ERR.NOT_FOUND&quot;</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">issuerid</span> <span class="o">=</span> <span class="nx">keyid</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">valid</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">issuerid</span> <span class="o">=</span> <span class="nx">keyid</span><span class="p">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">valid</span> <span class="o">=</span> <span class="nx">valid</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-msg-verified&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
  <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;pgp-search-publickey&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>
    <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-search-publickey-results&quot;</span><span class="p">,</span> <span class="nx">results</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;pgp-fetch-keyring&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">getAllKeys</span><span class="p">();</span>
    <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-fetched-keyring&quot;</span><span class="p">,</span> <span class="nx">keys</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;pgp-fetch-public-keys&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">getPublicKeys</span><span class="p">();</span>
    <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-fetched-public-keys&quot;</span><span class="p">,</span> <span class="nx">keys</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;pgp-fetch-all-keys&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">getAllKeys</span><span class="p">();</span>
    <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-fetched-all-keys&quot;</span><span class="p">,</span> <span class="nx">keys</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;pgp-fetch-private-keys&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">getPrivateKeys</span><span class="p">();</span>
    <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-fetched-private-keys&quot;</span><span class="p">,</span>  <span class="p">{</span> <span class="s2">&quot;keys&quot;</span><span class="o">:</span> <span class="nx">keys</span><span class="p">,</span> <span class="s2">&quot;default_key_id&quot;</span><span class="o">:</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">getDefault</span><span class="p">()</span> <span class="p">});</span>
  <span class="p">});</span>
  <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;pgp-options-fetch-keys&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-options-fetched-keys&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="s2">&quot;keys&quot;</span><span class="o">:</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">getPrivateKeys</span><span class="p">(),</span> <span class="s2">&quot;default_key_id&quot;</span><span class="o">:</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">getDefault</span><span class="p">()</span> <span class="p">});</span>
  <span class="p">});</span>
  <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;pgp-keyring-delete-subkey&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">subkeyid</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="p">{</span><span class="nx">rc</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">msg</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">subkeyid</span><span class="o">:</span> <span class="nx">subkeyid</span><span class="p">};</span>
    <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">ppgapp</span><span class="p">.</span><span class="nx">findKey</span><span class="p">(</span><span class="nx">subkeyid</span><span class="p">)</span>
    <span class="kd">var</span> <span class="nx">removed</span> <span class="o">=</span> <span class="nx">ppgapp</span><span class="p">.</span><span class="nx">removeSubkey</span><span class="p">(</span><span class="nx">keyid</span><span class="p">,</span> <span class="nx">subkey_num</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">removed</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="s2">&quot;Subkey &quot;</span> <span class="o">+</span> <span class="nx">subkeyid</span> <span class="o">+</span> <span class="s2">&quot;removed!&quot;</span><span class="p">;</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">subkeyid</span> <span class="o">=</span> <span class="nx">subkeyid</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="s2">&quot;Couldn&#39;t remove subkey &quot;</span> <span class="o">+</span> <span class="nx">subkeyid</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-keyring-deleted-subkey&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;pgp-keyring-delete-uid&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">keyid</span><span class="p">,</span> <span class="nx">uid_num</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="p">{</span><span class="nx">rc</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">msg</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">keyid</span><span class="o">:</span> <span class="nx">keyid</span><span class="p">,</span> <span class="nx">uid_num</span><span class="o">:</span> <span class="nx">uid_num</span><span class="p">};</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">ppgapp</span><span class="p">.</span><span class="nx">removeUserId</span><span class="p">(</span><span class="nx">keyid</span><span class="p">,</span> <span class="nx">uid_num</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="s2">&quot;Uid[&quot;</span> <span class="o">+</span> <span class="nx">uid_num</span> <span class="o">+</span> <span class="s2">&quot;] removed!&quot;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="s2">&quot;Couldn&#39;t remove uid[&quot;</span> <span class="o">+</span> <span class="nx">uid_num</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-keyring-deleted-uid&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;pgp-keyring-delete-keys&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">keys</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">deleted_keys</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="kd">var</span> <span class="nx">not_deleted_keys</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">ppgapp</span><span class="p">.</span><span class="nx">removeKey</span><span class="p">(</span><span class="nx">keys</span><span class="p">[</span><span class="nx">i</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nx">deleted_keys</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">keys</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
      <span class="p">}</span> <span class="k">else</span>
        <span class="nx">not_deleted_keys</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">keys</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">response</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">rc</span><span class="o">:</span> <span class="nx">deleted_keys</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">length</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
      <span class="nx">deleted_keys</span><span class="o">:</span> <span class="nx">deleted_keys</span><span class="p">,</span>
      <span class="nx">not_deleted_keys</span><span class="o">:</span> <span class="nx">not_deleted_keys</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-keyring-deleted-keys&quot;</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;pgp-keyring-delete-all-keys&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">num_keys</span> <span class="o">=</span> <span class="nx">ppgapp</span><span class="p">.</span><span class="nx">removeAllKeys</span><span class="p">();</span>
    <span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pgp-keyring-deleted-all-keys&quot;</span><span class="p">,</span> <span class="nx">num_keys</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">mainworker</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">maintab</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">openapp</span><span class="p">(</span><span class="nx">secname</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">tabs</span><span class="p">.</span><span class="nx">open</span><span class="p">({</span>
    <span class="nx">url</span>     <span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">url</span><span class="p">(</span><span class="s2">&quot;ui/main.html#&quot;</span> <span class="o">+</span> <span class="nx">secname</span><span class="p">),</span>
    <span class="nx">onReady</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">tab</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">apptab</span> <span class="o">=</span> <span class="nx">tab</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">worker</span> <span class="o">=</span> <span class="nx">tab</span><span class="p">.</span><span class="nx">attach</span><span class="p">({</span>
        <span class="nx">contentScript</span><span class="o">:</span> <span class="nx">sectionsContentScripts</span><span class="p">(),</span>
        <span class="nx">contentScriptFile</span><span class="o">:</span> <span class="p">[</span> <span class="nx">data</span><span class="p">.</span><span class="nx">url</span><span class="p">(</span><span class="s2">&quot;ui/ejs_production.js&quot;</span><span class="p">),</span>
                             <span class="nx">data</span><span class="p">.</span><span class="nx">url</span><span class="p">(</span><span class="s2">&quot;ui/ppg-lib.js&quot;</span><span class="p">),</span>
                             <span class="nx">data</span><span class="p">.</span><span class="nx">url</span><span class="p">(</span><span class="s2">&quot;ui/genkey.js&quot;</span><span class="p">),</span>
                             <span class="nx">data</span><span class="p">.</span><span class="nx">url</span><span class="p">(</span><span class="s2">&quot;ui/import_keys.js&quot;</span><span class="p">),</span>
                             <span class="nx">data</span><span class="p">.</span><span class="nx">url</span><span class="p">(</span><span class="s2">&quot;ui/encrypt.js&quot;</span><span class="p">),</span>
                             <span class="nx">data</span><span class="p">.</span><span class="nx">url</span><span class="p">(</span><span class="s2">&quot;ui/decrypt.js&quot;</span><span class="p">),</span>
                             <span class="nx">data</span><span class="p">.</span><span class="nx">url</span><span class="p">(</span><span class="s2">&quot;ui/sign.js&quot;</span><span class="p">),</span>
                             <span class="nx">data</span><span class="p">.</span><span class="nx">url</span><span class="p">(</span><span class="s2">&quot;ui/verify.js&quot;</span><span class="p">),</span>
                             <span class="nx">data</span><span class="p">.</span><span class="nx">url</span><span class="p">(</span><span class="s2">&quot;ui/options.js&quot;</span><span class="p">),</span>
                             <span class="nx">data</span><span class="p">.</span><span class="nx">url</span><span class="p">(</span><span class="s2">&quot;ui/export_selected.js&quot;</span><span class="p">),</span>
                             <span class="nx">data</span><span class="p">.</span><span class="nx">url</span><span class="p">(</span><span class="s2">&quot;ui/search_keys.js&quot;</span><span class="p">),</span>
                             <span class="nx">data</span><span class="p">.</span><span class="nx">url</span><span class="p">(</span><span class="s2">&quot;ui/welcome.js&quot;</span><span class="p">),</span>
                             <span class="nx">data</span><span class="p">.</span><span class="nx">url</span><span class="p">(</span><span class="s2">&quot;ui/manager.js&quot;</span><span class="p">),</span>
                             <span class="nx">data</span><span class="p">.</span><span class="nx">url</span><span class="p">(</span><span class="s1">&#39;ui/views/box.js&#39;</span><span class="p">),</span>
                             <span class="nx">data</span><span class="p">.</span><span class="nx">url</span><span class="p">(</span><span class="s1">&#39;ui/views/boxes.js&#39;</span><span class="p">),</span>
                             <span class="nx">data</span><span class="p">.</span><span class="nx">url</span><span class="p">(</span><span class="s1">&#39;ui/views/keylist_view.js&#39;</span><span class="p">),</span>
                             <span class="nx">data</span><span class="p">.</span><span class="nx">url</span><span class="p">(</span><span class="s1">&#39;ui/views/key_view.js&#39;</span><span class="p">),</span>
                             <span class="nx">data</span><span class="p">.</span><span class="nx">url</span><span class="p">(</span><span class="s1">&#39;ui/views/key_subkey_view.js&#39;</span><span class="p">),</span>
                             <span class="nx">data</span><span class="p">.</span><span class="nx">url</span><span class="p">(</span><span class="s1">&#39;ui/views/key_uid_view.js&#39;</span><span class="p">),</span>
                             <span class="nx">data</span><span class="p">.</span><span class="nx">url</span><span class="p">(</span><span class="s1">&#39;ui/views/key_uidsig_view.js&#39;</span><span class="p">),</span>
                             <span class="nx">data</span><span class="p">.</span><span class="nx">url</span><span class="p">(</span><span class="s1">&#39;ui/views/hkpkey_view.js&#39;</span><span class="p">),</span>
                             <span class="nx">data</span><span class="p">.</span><span class="nx">url</span><span class="p">(</span><span class="s1">&#39;ui/sprintf.js&#39;</span><span class="p">),</span>
                             <span class="nx">data</span><span class="p">.</span><span class="nx">url</span><span class="p">(</span><span class="s1">&#39;ui/tabs.js&#39;</span><span class="p">),</span>
                             <span class="nx">data</span><span class="p">.</span><span class="nx">url</span><span class="p">(</span><span class="s1">&#39;ui/dialogs.js&#39;</span><span class="p">),</span>
                             <span class="nx">data</span><span class="p">.</span><span class="nx">url</span><span class="p">(</span><span class="s1">&#39;ui/keyring.js&#39;</span><span class="p">),</span>
                             <span class="nx">data</span><span class="p">.</span><span class="nx">url</span><span class="p">(</span><span class="s2">&quot;ui/main.js&quot;</span><span class="p">)</span> <span class="p">],</span>
        <span class="nx">contentURL</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">url</span><span class="p">(</span><span class="s1">&#39;graphics/lock.png&#39;</span><span class="p">),</span>
      <span class="p">});</span>

      <span class="nx">load_events</span><span class="p">(</span><span class="nx">worker</span><span class="p">);</span>
      <span class="nx">maintab</span> <span class="o">=</span> <span class="nx">tab</span><span class="p">;</span>
      <span class="nx">mainworker</span> <span class="o">=</span> <span class="nx">worker</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">ppgapp_panel</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;panel&quot;</span><span class="p">).</span><span class="nx">Panel</span><span class="p">({</span>
  <span class="nx">width</span><span class="o">:</span> <span class="mi">250</span><span class="p">,</span>
  <span class="nx">height</span><span class="o">:</span> <span class="mi">250</span><span class="p">,</span>
  <span class="nx">contentURL</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">url</span><span class="p">(</span><span class="s2">&quot;ui/panel.html&quot;</span><span class="p">),</span>
  <span class="nx">contentScript</span><span class="o">:</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> 
        <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">get_all_options</span><span class="p">();</span>
        <span class="k">return</span> <span class="s2">&quot;\nPanel.init( &quot;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;);&quot;</span><span class="p">;</span>
  <span class="p">})(),</span>
  <span class="nx">contentScriptFile</span><span class="o">:</span> <span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">url</span><span class="p">(</span><span class="s2">&quot;ui/ejs_production.js&quot;</span><span class="p">),</span>
                      <span class="nx">data</span><span class="p">.</span><span class="nx">url</span><span class="p">(</span><span class="s2">&quot;ui/ppg-lib.js&quot;</span><span class="p">),</span>
                      <span class="nx">data</span><span class="p">.</span><span class="nx">url</span><span class="p">(</span><span class="s2">&quot;ui/panel.js&quot;</span><span class="p">)],</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">widget</span> <span class="o">=</span> <span class="nx">widgets</span><span class="p">.</span><span class="nx">Widget</span><span class="p">({</span>
  <span class="nx">id</span><span class="o">:</span> <span class="s2">&quot;ppgapp-link&quot;</span><span class="p">,</span>
  <span class="nx">label</span><span class="o">:</span> <span class="s2">&quot;PidgeonPG Website&quot;</span><span class="p">,</span>
  <span class="nx">contentURL</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">url</span><span class="p">(</span><span class="s1">&#39;graphics/logo.ico&#39;</span><span class="p">),</span>
  <span class="nx">panel</span><span class="o">:</span> <span class="nx">ppgapp_panel</span>
<span class="p">});</span>

<span class="nx">ppgapp_panel</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;open-section&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">maintab</span><span class="p">)</span> 
    <span class="k">for</span> <span class="nx">each</span><span class="p">(</span><span class="kd">var</span> <span class="nx">tab</span> <span class="k">in</span> <span class="nx">tabs</span><span class="p">)</span> 
      <span class="k">if</span> <span class="p">(</span><span class="nx">tab</span> <span class="o">==</span> <span class="nx">maintab</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">mainworker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;open-section&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
        <span class="nx">tab</span><span class="p">.</span><span class="nx">activate</span><span class="p">();</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
  <span class="nx">openapp</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">openapp</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">main</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">callbacks</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If you run cfx with --static-args='{"quitWhenDone":true}' this program
will automatically quit Firefox when it's done.
 if (options.staticArgs.quitWhenDone)
   callbacks.quit();</p></div></div><div class="code"><div class="wrapper"><span class="p">};</span></div></div></div></div></body></html>